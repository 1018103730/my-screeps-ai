# PB 采集小组设计案

由于目前框架不支持动态调配 creep 数量，对 PB 的采集会造成不小影响。因此将会在 PB 采集小组完成后尽早上线 creepSet 模块。

**前提**：8 级之前无法生成 25 HEAL 25 MOVE 的治疗者，所以请在 RCL 到 8 后再进行 PB 采集。

# 基本组成

- 采集旗帜：标记采集位置，记录采集进度和基本信息
- 攻击单位：攻击 PB，在成功拆除后更新 flag 状态并自杀
- 治疗单位：治疗攻击单位，在 flag 状态更新后自杀
- 运输单位：提前孵化，搬运后检查剩余存活是否足够再搬一次，足够的话就搬运。否则自杀

应提前配置好至少 (1\*攻击 1\*治疗 2\*运输) 的 creep 小组。

# 采集阶段

- 攻击阶段 `attack`: 需要进攻单位进行拆除。
- 准备阶段 `prepare`: 开始生成运输单位，但是运输单位在抵达现场后会在一定距离处待命。
- 运输阶段 `transfe`: 需要运输单位进行搬运。

# 攻击单位

**isNeed 阶段**

- 检查是否有指定名称的旗帜。
- 从旗帜内存中获取当前是否为 `attack` 或 `prepare` 阶段。
    - 不存在或者是该阶段：生成。
    - 不是该阶段：不生成。

**prepare 阶段**

- 向移动至旗帜位置
- 检查当前位置是否等于旗帜位置：
    - 是：检查旗帜中是否存在 `travelTime`：
        - 否：`travelTime` 等于自己最大 TTL 减去当前 TTL。
        - return true
    - 否：return false

**target 阶段**

- 新建目标对象，置初值为 undefined。
- 检查旗帜内存中是否有 `PowerBankId`:
    - 有，获取其对象，对象存在则赋值给目标对象。
    - 没有的话：搜索旗帜周围一格范围内的 PB。
        - 找到了：将其 id 写入旗帜内存，赋值为目标对象。
- 检查目标对象是否存在。
    - 不存在：搜索旗帜周围一格范围内的 Ruin。
        - 还是没找到：任务失败，移除旗帜，自杀。
        - 找到了：将采集阶段置为 `transfe`，自杀。
- 攻击目标（不关心伤势），检查返回值。
- 如果返回 OK 的话。检查 **PB 剩余生命值是否小于 `(travelTime + 150) * 600`**。
    - 是的话将阶段置为 `prepare`。

**身体部件**: 20\*ATTACK, 20\*MOVE（这个比例是 25 HEAL 能治疗的极限）

# 治疗单位

**isNeed 阶段**

- 进攻单位是否存在。
    - 不存在：不生成。
- 生成。

**prepare 阶段**

- 向进攻单位移动
- 检查位置是否相邻：
    - 相邻的话 return true
- return false

**target 阶段**

- 获取进攻单位
- 进攻单位是否存在
    - 不在了：自杀。
    - 在：使劲治疗。

**身体部件**: 25\*HEAL, 25\*MOVE

# 运输单位

**isNeed 阶段**

- 检查是否有指定名称的旗帜。
- 从旗帜内存中获取当前是否为 `prepare` 或 `transfe` 阶段。
    - 不是该阶段：不生成。
    - 是：生成。

**source 阶段**

- 获取 PB Ruin
- 从 Ruin 中取出资源，检查返回值
    - 如果离得太远：
        - 如果是 `prepare` 阶段：移动到旗帜三格范围内待命
        - 如果是 `transfe` 阶段：移动到旗帜上
    - 如果 OK：检查 Ruin 内是否还有 Power
        - 没有：移除旗帜

**target 阶段**

- 搬运回终端（默认）或者指定建筑，检查返回值
- 如果返回 OK 则 **检查自己剩余生命值是否小于两倍的 `travelTime`**。
    - 如果小于则自杀。

**switch 阶段**

- 自己携带有 Power（无论多少）就 return true
- 否则就 return false

**身体部件**: 25\*CARRY, 25\*MOVE

# 持久化

`pbFlag.memory`

```ts
{
    // 当前采集所处的阶段
    state: string
    // 移动至 pb 所需的时间
    travelTime: number
    // pb 的 id
    sourceId: string
}
```